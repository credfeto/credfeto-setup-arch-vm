#! /bin/sh

die() {
    echo
    echo "$@"
    exit 1
}


echo "Updating pacman.conf"

sed -i "s|Include = /etc/pacman.d/mirrorlist|Server = https://pacman.markridgwell.com/repo/archlinux/\$repo/os/\$arch|" /etc/pacman.conf || die "Could not update pacman.conf"


echo "Updating Packages"
pacman -Syu --noconfirm || die "Could not update dist"

echo "Ensuring docker is installed"
pacman -S --noconfirm --needed docker docker-compose docker-buildx git pigz criu || die "Could not install docker"


echo "Installing auto-update service"
{
  echo "[Unit]"
  echo "Description=Run arch-update auto check"
  echo "After=network-online.target"
  echo ""
  echo "[Service]"
  echo "Type=oneshot"
  echo "ExecStart=pacman -Syyu --noconfirm"
} > /etc/systemd/system/auto-update.service


{
echo "[Unit]"
echo "Description=Run arch-update auto check at boot and then every hour"
echo ""
echo "[Timer]"
echo "OnStartupSec=15"
echo "OnUnitActiveSec=1h"
echo ""
echo "[Install]"
echo "WantedBy=timers.target"
} > /etc/systemd/system/auto-update.timer

systemctl daemon-reload || die "could not update systemd daemon config"

systemctl enable --now auto-update.timer || die "Could not enable service"


echo "Done"
